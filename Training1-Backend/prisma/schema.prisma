// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String  @id @default(uuid())
  slug      String  @unique
  name      String
  plan      String  @default("standard")
  branding  Json    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  users     User[]
  courses   Course[]
  assignments Assignment[]
  
  @@map("tenants")
}

model User {
  id         String   @id @default(uuid())
  tenantId   String
  email      String
  givenName  String?
  familyName String?
  roles      String[] @default(["LEARNER"]) // SUPER_ADMIN, BROKER_ADMIN, MANAGER, LEARNER
  attrs      Json     @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  enrollments Enrollment[]
  
  @@unique([tenantId, email])
  @@map("users")
}

model Course {
  id        String   @id @default(uuid())
  tenantId  String
  title     String
  status    String   @default("draft") // draft|published
  meta      Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  modules     Module[]
  assignments Assignment[]
  enrollments Enrollment[]
  
  @@map("courses")
}

model Module {
  id       String @id @default(uuid())
  courseId String
  title    String
  order    Int
  
  // Relations
  course  Course   @relation(fields: [courseId], references: [id])
  lessons Lesson[]
  
  @@map("modules")
}

model Lesson {
  id       String @id @default(uuid())
  moduleId String
  title    String
  order    Int
  
  // Relations
  module     Module     @relation(fields: [moduleId], references: [id])
  activities Activity[]
  
  @@map("lessons")
}

model Activity {
  id       String @id @default(uuid())
  lessonId String
  type     String // video|doc|slide|walkthrough|quiz|assignment|live
  config   Json
  
  // Relations
  lesson Lesson @relation(fields: [lessonId], references: [id])
  
  @@map("activities")
}

model Assignment {
  id        String    @id @default(uuid())
  tenantId  String
  courseId  String
  createdBy String
  dueAt     DateTime?
  policy    Json      @default("{}")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  course      Course       @relation(fields: [courseId], references: [id])
  targets     AssignmentTarget[]
  enrollments Enrollment[]
  
  @@map("assignments")
}

model AssignmentTarget {
  id           String @id @default(uuid())
  assignmentId String
  targetType   String // user|group|attribute
  targetRef    String
  
  // Relations
  assignment Assignment @relation(fields: [assignmentId], references: [id])
  
  @@map("assignment_targets")
}

model Enrollment {
  id           String  @id @default(uuid())
  userId       String
  courseId     String
  assignmentId String?
  status       String  @default("not_started") // not_started|in_progress|completed|expired
  progressPct  Int     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  user       User        @relation(fields: [userId], references: [id])
  course     Course      @relation(fields: [courseId], references: [id])
  assignment Assignment? @relation(fields: [assignmentId], references: [id])
  attempts   Attempt[]
  
  @@unique([userId, courseId, assignmentId])
  @@map("enrollments")
}

// Assessment Models
model AssessmentItem {
  id        String   @id @default(uuid())
  tenantId  String
  type      String   // mc|tf|essay|matching|hotspot|ordering
  stem      String
  config    Json     @default("{}")
  tags      String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("assessment_items")
}

model AssessmentForm {
  id        String   @id @default(uuid())
  tenantId  String
  title     String
  config    Json     @default("{}")
  items     Json     // Array of item references with scoring
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  attempts  Attempt[]
  
  @@map("assessment_forms")
}

model Attempt {
  id           String    @id @default(uuid())
  enrollmentId String
  formId       String
  startedAt    DateTime  @default(now())
  submittedAt  DateTime?
  score        Float?
  responses    Json      @default("{}")
  proctoring   Json?
  
  enrollment Enrollment     @relation(fields: [enrollmentId], references: [id])
  form       AssessmentForm @relation(fields: [formId], references: [id])
  
  @@map("attempts")
}

// Media Models
model MediaFile {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  filename    String
  mimeType    String
  size        Int
  s3Key       String
  status      String   @default("uploaded") // uploaded|processing|ready|error
  metadata    Json     @default("{}")
  transcripts Json?
  createdAt   DateTime @default(now())
  
  @@map("media_files")
}

// Live Session Models
model LiveSession {
  id            String    @id @default(uuid())
  tenantId      String
  title         String
  scheduledAt   DateTime?
  startedAt     DateTime?
  endedAt       DateTime?
  status        String    @default("scheduled") // scheduled|active|ended
  config        Json      @default("{}")
  recordingUrl  String?
  createdAt     DateTime  @default(now())
  
  participants  LiveParticipant[]
  polls         LivePoll[]
  
  @@map("live_sessions")
}

model LiveParticipant {
  id        String   @id @default(uuid())
  sessionId String
  userId    String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  role      String   @default("attendee") // host|presenter|attendee
  
  session LiveSession @relation(fields: [sessionId], references: [id])
  
  @@map("live_participants")
}

model LivePoll {
  id        String   @id @default(uuid())
  sessionId String
  question  String
  options   Json
  results   Json     @default("{}")
  createdAt DateTime @default(now())
  
  session LiveSession @relation(fields: [sessionId], references: [id])
  
  @@map("live_polls")
}

// Compliance Models
model Certificate {
  id           String   @id @default(uuid())
  userId       String
  courseId     String
  issuedAt     DateTime @default(now())
  expiresAt    DateTime?
  certificateUrl String
  metadata     Json     @default("{}")
  
  @@map("certificates")
}

model SeatTimeSession {
  id        String    @id @default(uuid())
  userId    String
  courseId  String
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int       @default(0) // seconds
  
  @@map("seat_time_sessions")
}

model AuditLog {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String?
  action    String
  resource  String
  details   Json     @default("{}")
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

// Analytics Models
model XAPIStatement {
  id        String   @id @default(uuid())
  tenantId  String
  actor     Json
  verb      Json
  object    Json
  result    Json?
  context   Json?
  timestamp DateTime @default(now())
  
  @@index([tenantId, timestamp])
  @@map("xapi_statements")
}

// Notification Models
model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String    // info|warning|success|error
  title     String
  message   String
  readAt    DateTime?
  data      Json?
  createdAt DateTime  @default(now())
  
  @@index([userId, createdAt])
  @@map("notifications")
}

model NotificationQueue {
  id          String    @id @default(uuid())
  channel     String    // email|sms|push
  recipient   String
  subject     String?
  content     String
  status      String    @default("pending") // pending|sent|failed
  sentAt      DateTime?
  error       String?
  attempts    Int       @default(0)
  scheduledAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  
  @@index([status, scheduledAt])
  @@map("notification_queue")
}

// Billing Models
model Subscription {
  id              String    @id @default(uuid())
  tenantId        String    @unique
  plan            String
  status          String    // active|cancelled|past_due
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAt        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("subscriptions")
}

model Invoice {
  id            String   @id @default(uuid())
  tenantId      String
  amount        Int      // cents
  currency      String   @default("usd")
  status        String   // draft|open|paid|void
  stripeInvoiceId String?
  pdfUrl        String?
  paidAt        DateTime?
  createdAt     DateTime @default(now())
  
  @@map("invoices")
}

// Job Queue Models
model Job {
  id          String    @id @default(uuid())
  type        String    // video_transcode|pdf_render|email_send
  status      String    @default("pending") // pending|processing|completed|failed
  priority    Int       @default(0)
  data        Json
  result      Json?
  error       String?
  attempts    Int       @default(0)
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  
  @@index([status, priority])
  @@map("jobs")
}

// Interactive Video Models
model InteractiveVideo {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  mediaFileId String   // Base video file
  duration    Int      // seconds
  config      Json     @default("{}") // Player settings
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  interactions VideoInteraction[]
  
  @@map("interactive_videos")
}

model VideoInteraction {
  id        String   @id @default(uuid())
  videoId   String
  type      String   // question|hotspot|overlay|chapter|link
  timestamp Int      // When to show (seconds)
  duration  Int?     // How long to show
  config    Json     // Type-specific config
  required  Boolean  @default(false)
  createdAt DateTime @default(now())
  
  video     InteractiveVideo @relation(fields: [videoId], references: [id])
  responses VideoInteractionResponse[]
  
  @@index([videoId, timestamp])
  @@map("video_interactions")
}

model VideoInteractionResponse {
  id            String    @id @default(uuid())
  interactionId String
  userId        String
  enrollmentId  String?
  response      Json
  correct       Boolean?
  submittedAt   DateTime  @default(now())
  
  interaction VideoInteraction @relation(fields: [interactionId], references: [id])
  
  @@map("video_interaction_responses")
}

// AI Video Generation Models
model VideoProject {
  id          String   @id @default(uuid())
  tenantId    String
  title       String
  type        String   // avatar|animation|slideshow|screen_recording
  status      String   @default("draft") // draft|generating|ready|failed
  script      String?
  config      Json     @default("{}")
  outputUrl   String?
  thumbnailUrl String?
  duration    Int?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  scenes VideoScene[]
  
  @@map("video_projects")
}

model VideoScene {
  id          String   @id @default(uuid())
  projectId   String
  order       Int
  type        String   // avatar|text|image|animation
  duration    Int      // seconds
  config      Json     // Scene-specific config
  voiceText   String?
  voiceConfig Json?    // Voice settings (pitch, speed, etc)
  createdAt   DateTime @default(now())
  
  project VideoProject @relation(fields: [projectId], references: [id])
  
  @@map("video_scenes")
}

model AIAvatar {
  id          String   @id @default(uuid())
  name        String
  gender      String   // male|female|neutral
  style       String   // realistic|cartoon|professional
  thumbnailUrl String
  modelUrl    String   // Path to avatar model
  voiceId     String?  // Associated TTS voice
  isPublic    Boolean  @default(true)
  tenantId    String?  // null = platform avatar
  createdAt   DateTime @default(now())
  
  @@map("ai_avatars")
}

model AIVoice {
  id          String   @id @default(uuid())
  name        String
  language    String   // en-US, es-ES, etc
  gender      String
  style       String   // professional|casual|energetic|calm
  provider    String   // elevenlabs|azure|google
  voiceId     String   // Provider's voice ID
  sampleUrl   String?  // Sample audio
  isPublic    Boolean  @default(true)
  tenantId    String?
  createdAt   DateTime @default(now())
  
  @@map("ai_voices")
}